---
title: Joint Models of Longitudinal Outcomes and Time-to-Event Data

author:
  - name: Phoebe Wong Hui Lei 
  - name: Anushka Muley
    affil: 1
affiliation:
  - num: 1
    address: School of Mathematical and Statistical Sciences, University of Galway
logoleft_name: https&#58;//sport.universityofgalway.ie/assets/img/logo2.png

poster_height: "594mm"
poster_width: "841mm"
column_numbers: 5
column_margins: "0.5in"	
primary_colour:	"#a80050"	# Secondary colour use for poster design.
secondary_colour:	"#84003d"	# Main colour used for poster design.
accent_colour:	"#e6007e"	# A third colour option.
author_textcol: "white"
title_textsize: "70pt"
author_textsize: "60pt"
body_textsize: "25pt"
output: 
  posterdown::posterdown_html:
    self_contained: true
    pandoc_args: --mathjax
    number_sections: false
knit: pagedown::chrome_print
---

```{css, echo=FALSE}
div.logo_left{
  width: 20%;
}
div.poster_title{
  width: 80%;
}
.section h4 {
    break-after: column;
}
div.footnotes {
    font-size: 18pt;
}
#references {
  font-size: 14pt;
}
.caption,
.figcaption,
figure figcaption {
  font-size: 12pt !important;
}
```

<!-- Don't change anything above, except the title and author names, unless you know what you are doing. -->

```{r, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      tidy = FALSE,
                      message = FALSE,
                      fig.align = 'center',
                      out.width = "100%")
options(knitr.table.format = "html") 
# Load any additional libraries here
library(tidyverse)
library(plotly)
library(kableExtra)
```

# Background and Problem

Patients are repeatedly monitored with biomarkers that reflect health status and influence event risk.Standard separate models ignore their dependence,leading to biased estimates and poorer predictions.Joint models link longitudinal and survival processes through shared random effects.This approach improves inference and enabling dynamic,patient-specific risk prediction.



### Objectives of Project

1. To implement joint models for longitudinal biomarkers and survival using real clinical data.
2. To investigate how ignoring biomarker–event dependence on parameter estimates and risk predictions.
3. To assess the benefit of joint models for dynamic,individualized survival prediction.

# Data Sources and Datasets

Open source dataset from R packages:

- AIDS ("aids") dataset from R package, "JM" 
- PBC ("pbc2") dataset from R package, "JMbayes2"

<!-- This #### below causes the columns to break -->

<!-- You can change where you put these breaks, and the "column_numbers: 4" argument in the YAMLS header to change the layout of the poster, with care! -->

####

# Early Results / Descriptive Statistics of Datasets

- AIDS dataset

```{r mytable, out.width='80%'}
library(gtsummary)

# load dataset 
data("aids", package = "JM")

aids_df <- aids %>%
  mutate(
    id     = as.integer(patient),  # explicit subject ID
    logCD4 = log(CD4)
  ) %>%
  arrange(id, obstime)

#extract a summary of data
tb1 <- aids_df %>% tbl_summary(by=death,
                        include = c(gender,obstime,prevOI,AZT,drug))%>% 
  add_overall()

tb1%>% modify_caption("Summary of AIDS dataset based on death events")

```

```{r, results = "asis" , echo=FALSE,fig.cap = "(CD4 trajectories) Shows substantial between-patient heterogeneity and overall decline in CD4 over time"}
ggplot(aids_df, aes(x = obstime, y = logCD4, group = id)) +
  geom_line(alpha = 0.2) +
  stat_smooth(aes(group = 1), method = "loess", se = TRUE, linewidth = 1) +
  labs(
    title="AIDS: log(CD4) trajectories over time",
    x = "obstime", y = "log(CD4)"
  )

```

```{r coxph, results = "asis" , echo=FALSE,fig.cap = "(KM curve): Demonstrates high mortality rate, motivating time-to-event modelling."}
library(survival)
library(dplyr)
library(survminer)

aids_surv <- aids_df %>%
  distinct(id, Time, death)

aids_base <- aids_df %>%
  group_by(id) %>%
  arrange(obstime, .by_group = TRUE) %>%
  slice(1) %>%                     # baseline record per subject
  ungroup() %>%
  mutate(
    cd4_grp = ntile(CD4, 3),
    cd4_grp = factor(cd4_grp, labels = c("Low","Medium","High"))
  )

# Pull baseline covariates 
aids_cov <- aids_df %>%
  group_by(id) %>%
  slice(1) %>%                     # baseline covariates per subject
  ungroup() %>%
  select(id, prevOI, drug, AZT,gender)


# Survival frame with tertiles + covariates
km_aids_df <- aids_surv %>%
  left_join(aids_base %>% select(id, cd4_grp), by = "id") %>%
  left_join(aids_cov, by = "id") %>%
  filter(!is.na(cd4_grp))

fit_km_aids <- survfit(Surv(Time, death) ~ cd4_grp, data = km_aids_df)

ggsurvplot(
  fit_km_aids, data = km_aids_df, risk.table = TRUE,
  ggtheme = theme_minimal(),
  title = "AIDS: Survival by baseline CD4 tertiles",
  legend.title = "Baseline CD4"
)
  
```



```{r lme, results = "asis" , echo=FALSE}
library(nlme)
library(broom.mixed)

#linear mix effect model dataframe
aids_lme_df <- aids_df %>% 
  mutate(logCD4=log1p(CD4))%>% 
  filter(is.finite(logCD4), is.finite(obstime))


#linear mixed model
aids_lme_full <- nlme::lme(
  logCD4~obstime+gender+drug+AZT+prevOI,
  random=~obstime|id,
  data=aids_lme_df)


```



```{r jm, results = "asis", echo=FALSE}

library(sjPlot)

cox_aids_full <- coxph(Surv(Time, death) ~ gender+drug+AZT+prevOI, data = km_aids_df, x = TRUE)


jm_aids_full <- JM::jointModel(
  lmeObject = aids_lme_full,
  survObject = cox_aids_full,
  timeVar = "obstime"
)


summary_cox_aids_full <- summary(cox_aids_full)
table2_cox_aids <- data.frame(summary_cox_aids_full$coefficients)

table2_cox_aids <- table2_cox_aids%>% 
  mutate(Term = rownames(.)) %>%
  mutate(
                     coef = round(coef, 3),
                     exp.coef. = round(exp.coef., 3),
                     se.coef. = round(se.coef., 3),
                     Pr...z.. = round(Pr...z.., 3),
              
                  ) %>%
  rowwise()%>%
  mutate(
  # Format p-value
                    Pr...z.. = {
                    
                    # First decide how to display p
                    p_char <- if (Pr...z.. == 0) {
                      "<0.001"
                    } else {
                      as.character(Pr...z..)
                    }
                    
                    }
  )%>% 
  select(-z)%>%
  select(Term, coef,exp.coef., se.coef.,Pr...z..)

summary_jm_aids_full <- summary(jm_aids_full)
#full covariate
table2_jm <- bind_rows(
  data.frame(summary_jm_aids_full[[1]]), #longitudinal
  data.frame(),
  data.frame(summary_jm_aids_full[[2]]) #survival
)%>%
  # Keep term names as a column
  mutate(Term = rownames(.)) %>%
  # Round numeric columns first
  mutate(
    Value = round(Value, 3),
    Std.Err = round(Std.Err, 3),
    z.value = round(z.value, 3),
    p.value = round(p.value, 3)
  ) %>%
  rowwise() %>%  # process each row individually
  mutate(
    # Highlight Value in red if Term contains "Assoct"
    Value = if (grepl("Assoct", Term)) {
      cell_spec(as.character(Value), "html", color = "red")
    } else {
      as.character(Value)
    },
    # Format p-value
  p.value = {
    
    # First decide how to display p
    p_char <- if (p.value == 0) {
      "<0.001"
    } else {
      as.character(p.value)
    }
    
    # Then decide if it should be bold
    if (p.value < 0.05) {
      cell_spec(p_char, "html", bold = TRUE)
    } else {
      p_char
    }
  }
  ) %>%
  ungroup() %>%
  # Reorder columns so Term is first
  select(Term, Value, Std.Err, p.value)

table2_jm%>% kable(
    caption = "Joint model with full covariates",
    align = 'c',
    format = "html",
    escape = FALSE
  ) %>%
  kable_styling(font_size = 20)%>%
  footnote(
    general = "Association: paramater that shows longitudinal and time to event sub models correlated and captures subject level heterogeneity.",
    general_title = ""
  )

cat("<br></br>")

table2_cox_aids%>%
  kable(
    caption = "Cox model with full covariates",
    align = 'c',
    format = "html",
    escape = FALSE
  )%>%
  kable_styling(font_size = 20)

```


####

```{r}
fixed_df <- broom.mixed::tidy(aids_lme_full) %>%
  select(term, estimate, std.error, statistic, p.value) %>%
  mutate(
    estimate = round(estimate, 3),
    std.error = round(std.error, 3),
    statistic = round(statistic, 3),
    p.value = ifelse(round(p.value, 3) == 0, "<0.001", round(p.value, 3))
  
  )

# Create a kable table with styling
fixed_df %>%
  kable(
    caption = "Mixed Effects Model with full covariates",
    align = 'c',
    format = "html",
    escape = FALSE
  ) %>%
  kable_styling(font_size = 20, full_width = FALSE, bootstrap_options = c("striped", "hover"))
```


- PBC dataset
```{r}
# PBC data (JMbayes2)
data("pbc2", package = "JMbayes2")
data("pbc2.id", package = "JMbayes2")

pbc <- pbc2 %>%
  mutate(id = as.integer(id),
         sex = factor(sex)) %>%
  arrange(id, year)

# survival frame with explicit {0,1} event indicator
pbc_surv <- pbc2.id %>%
  mutate(
    id = as.integer(id),
    event = as.integer(status2 != 0),
    sex = factor(sex) 
  )

```

```{r,fig.cap = "(serBilir trajectories) Shows substantial between-patient heterogeneity and overall decline in serBilir over time"}
ggplot(pbc, aes(x = year, y = log(serBilir), group = id)) +
  geom_line(alpha = 0.15, color = "grey40") + 
  stat_smooth(aes(group = 1), method = "loess", se = TRUE, 
              color = "#a80050", fill = "#e6007e", linewidth = 1.2) +
  labs(x = "Years since baseline", 
       y = "log(serum bilirubin)",
       title="PBC: log(serBilir) trajectories over time") +
  theme_minimal()
```


```{r,fig.cap = "(KM curve): Demonstrates high mortality rate, motivating time-to-event modelling."}
library(survival)
library(survminer)
pbc_surv <- pbc2.id %>%
  mutate(id = as.integer(id),
         event = as.integer(status2 != 0))

pbc_base <- pbc %>%
  group_by(id) %>%
  arrange(year, .by_group = TRUE) %>%
  slice(1) %>%
  ungroup() %>%
  mutate(bili_grp = ntile(serBilir, 3),
         bili_grp = factor(bili_grp, labels = c("Low","Med","High")))

km_df <- pbc_surv %>%
  left_join(pbc_base %>% select(id, bili_grp), by = "id") %>%
  filter(!is.na(bili_grp))

fit_km_pbc <- survfit(Surv(years, event) ~ bili_grp, data = km_df)
ggsurvplot(
  fit_km_pbc, 
  data = km_df, 
  risk.table = TRUE,
  palette = c("#e6007e", "#a80050", "#84003d"), 
  title = "Survival by Baseline Bilirubin",
  xlab = "Years", 
  ylab = "Survival Prob.",
  legend.title = "Bilirubin",
  legend.labs = c("Low", "Med", "High"),
  fontsize = 3.5,           
  tables.height = 0.25,    
  ggtheme = theme_minimal(base_size = 10), 
  risk.table.theme = theme_survminer(base_size = 9) 
)
```

#### 

# Next Project Steps


- Apply joint model to PBC dataset

- Perform dynamic survival prediction at landmark times

- Compare predictive accuracy (AUC / Brier score) between joint and separate models

- Apply methodology to a real-world dataset (e.g. Framingham heart study dataset)


# GitHub

The code and datasets for this project can be viewed at our GitHub repository here: <https://github.com/phoebe25246966/HDS-Research-Project>


# References

1) Cekic et al. (2021). Joint modeling tutorial in R. Quant Comput Methods Behav Sci.

2) Mchunu et al. (2020). Joint CD4–mortality model. BMC Infect Dis.

3) Rizopoulos (2012). Joint Models for Longitudinal & Time-to-Event Data. CRC Press.

4) Rizopoulos (2016). JMbayes R package. J Stat Softw.

5) Wang & Zhong (2025). Joint longitudinal–survival modeling. Annu Rev Stat Appl.


